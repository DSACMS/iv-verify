# State Configuration

## Status

Proposed

## Context

iv-verify was designed to support multiple states and benefits. While there is a lot of overlap in the information requested of the end user there are a number of items that are specific to a particular state such as:
 - Copy: Specific text could be required by certain states
 - Numbers/Values: Standard deduction % will be different by state
 - URLs: Linking the user to documentation will be different by state
 - Flow Logic: Some states may require certain screens which will need to be done by configuration

There are three decisions that are proposed in this ADR: Storage of configuration, storage of state specific copy, and routing between configurations.

### Storage of configuration

Storing of state specific values, urls, and logic variables should be stored on a state by state basis. The two options being evaluated are storage in a database, separate service, or configuration file.

#### Storage in database

The main benefit of storing configuration in a database is that it can be updated without a new deploy. In this solution a configuration table would be created with each row consisting of the configuration for the state. The drawback to storing configuration in the database is that because iv-verify does not currently use a database it would require standing up the infrastucture.

#### Storage in a separate service

This option allows for all configuration to be separated from the iv-verify service and put in it's own configuration service.


#### Storage of configuration in file

This option would see the configuration put in a json or yaml file that is bundled with the app code on deploy. The advantages of this solution is that there is version control for all configuration changes and it does not require standing up a database or separate service. The downside is that to make a configuration change a new deploy would have to be done.

### Storage of state specific copy

Copy used in iv-verify shouuld be configurable by state. Additionally all copy should be able to be translated by the iv-verify i18n system. The decision of how to store the state specific copy is to either store the text in the same file with different keys or in separate files with the same key. In both options a change needs to be made to the `t()` function to look up state specific copy if it exists.

#### Separate file - different keys

In this option the text for state specific copy would be stored together. The `/app/i18n/locales/en/translation.json` file would have keys like: `add_expense_amount_field` and then state specific overrides like: `add_expense_amount_field__or` where "or" is the state key for Oregon. The `t()` function would keep track of which state configuration is being used and look up the state specific key if that doesn't exist it would fallback to the regular key.

#### Separate files - same key

In this option the text for the state specific copy is stored in spearate files such as `/app/i18n/locales/en/or.json`. This file would include keys such as `add_expense_amount_field` that overwrite the values in the `/app/i18n/locales/en/translation.json` file. The `t()` function would first look to the state configuration file before looking to the fallback file. This functionality does not exist in the i18n next infrastructure and would need to be developed.

### Routing between configurations

Once an end user arrives on iv-verify they need to be able to start an application for a particular state. Which state a user is using can be configured in either the URL or in a Cookie.

#### URL

In this option the URL for the ledger add screen goes from https://verify-prototype.app.cloud.gov/ledger/income/add to https://verify-prototype.app.cloud.gov/or/ledger/income/add where "or" is the state configuration key (OR for Oregon). This option makes it very clear which flow you are in and can make testing easier. The downside is that it requires a bit of work to modify the URLRouter to generate the URLs correctly to navigate between screens.

#### Cookie

In this option the URL for the ledger add screen states the same but when the user initiates the flow a cookie is set to indicate which flow the user is in. Both the client and server will have access to this cookie to navigate the user down the flow. The downside to this solution is that is not visibly clear which flow a user is unless the UI is modified to say so.

## Decision

The recommendations are as follows:

### Storage

Configuration should be stored in files for iv-verify. This requires the least upfront work and provides version control for configuration changes. iv-verify is not at the point where making configuration changes without a deploy is necessary.

### Routing

Routing should be handled through the URL. This option may require additional up front work as the URLs will need to be altered but it does create a clear system for indicating which configuration is being used. As iv-verify currently utalizes a high degree of static rendering which can be easier done on by URL.

#### Copy storage

Copy should be stored in the same file but with different keys. This is the easiest option to get up and running.

## Consequences

...