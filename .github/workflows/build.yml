name: CI

on:
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
      - run: npm ci
      - run: npm run build
      - run: npm run coverage
      - name: Find workflow id
        uses: actions/github-script@v7
        id: find-workflow-id
        with:
          github-token: ${{ secrets.GH_TOKEN_COVERAGE }}
          script: |
            const workflows = await github.request('GET /repos/{owner}/{repo}/actions/workflows', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            })

            const mainWorkflow = workflows.data.workflows.find((workflow) => workflow.name == "Main")
            if (!mainWorkflow || !mainWorkflow.id) {
              return core.setFailed('Unable to find main workflow id')
            }
            core.setOutput('mainWorkflowId', mainWorkflow.id)
      - name: Find Latest Run id
        uses: actions/github-script@v7
        id: find-workflow-run-id
        env:
          MAIN_WORKFLOW_ID: ${{ steps.find-workflow-id.outputs.mainWorkflowId }}
        with:
          github-token: ${{ secrets.GH_TOKEN_COVERAGE }}
          script: |
            const mainWorkflowId = process.env['MAIN_WORKFLOW_ID']
            const baseSha = "${{ github.event.pull_request.base.sha }}"
            const mainWorkflowRuns = await github.request('GET /repos/{owner}/{repo}/actions/workflows/{workflow_id}/runs', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: mainWorkflowId,
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            })

            console.log(mainWorkflowRuns)
            const mainWorkflowRun = mainWorkflowRuns.data.workflow_runs.find((run) => run.head_sha == baseSha)
            if (!mainWorkflowRun) {
              return core.setFailed("Unable to find main workflow run")
            }
            core.setOutput('mainWorkflowRunId', mainWorkflowRun.id)
            core.setOutput('mainWorkflowRunSha', mainWorkflowRun.head_sha)
      - name: Download coverage artifact from build of main branch
        uses: actions/download-artifact@v4
        with:
          name: verify-prototype-covearge-${{ steps.find-workflow-run-id.outputs.mainWorkflowRunSha }}.json
          run-id: ${{ steps.find-workflow-run-id.outputs.mainWorkflowRunId }}
          github-token: ${{ secrets.GH_TOKEN_COVERAGE }}
      - name: Diff code coverage results
        uses: actions/github-script@v7
        env:
          MAIN_WORKFLOW_RUN_SHA: ${{ steps.find-workflow-run-id.outputs.mainWorkflowRunSha }}
        with:
          script: |
            const script = require('./scripts/compare_coverage.js')
            script({github, context, process.env['MAIN_WORKFLOW_RUN_SHA']})